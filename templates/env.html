{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4">Konfigurace (.env)</h2>

  <!-- Glob√°ln√≠ info -->
  <div class="alert alert-info d-flex align-items-start gap-2">
    <div>
      <strong>N√°povƒõda:</strong> P≈ôejeƒè my≈°√≠ ikony
      <span class="text-secondary" data-bs-toggle="tooltip" title="Tooltip p≈ô√≠kladu"><i class="bi bi-question-circle-fill"></i></span>
      pro detail. Formul√°≈ô prov√°d√≠ z√°kladn√≠ klientskou validaci hodnot (IP, porty, ƒç√≠sla). Ulo≈æen√≠ p≈ôep√≠≈°e odpov√≠daj√≠c√≠ polo≈æky v <code>.env</code>.
    </div>
  </div>

  <form method="post" class="needs-validation" novalidate id="envForm">
    <div class="row g-4">

      <!-- Proxy -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <strong>Proxy nastaven√≠</strong>
            <i class="bi bi-question-circle-fill"
               data-bs-toggle="tooltip"
               title="Proxy naslouch√° na LISTEN_IP:LISTEN_PORT a p≈ôepojuje na PROXY_TARGET_IP:PROXY_TARGET_PORT."></i>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-sm-6">
                <label class="form-label">LISTEN_IP</label>
                <input type="text"
                       class="form-control"
                       name="LISTEN_IP"
                       value="{{ values.LISTEN_IP }}"
                       pattern="^((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)|\*|0\.0\.0\.0$"
                       data-bs-toggle="tooltip"
                       title="IP, na kter√© proxy naslouch√° (nap≈ô. 0.0.0.0 pro v≈°echny)."
                       required>
                <div class="form-text">Nap≈ô. <code>0.0.0.0</code> (v≈°echny rozhran√≠) nebo konkr√©tn√≠ IP.</div>
                <div class="invalid-feedback">Zadej platnou IP (nap≈ô. 0.0.0.0, 127.0.0.1, 192.168.1.5).</div>
              </div>
              <div class="col-sm-6">
                <label class="form-label">LISTEN_PORT</label>
                <input type="number"
                       class="form-control"
                       name="LISTEN_PORT"
                       value="{{ values.LISTEN_PORT }}"
                       min="1" max="65535"
                       data-bs-toggle="tooltip"
                       title="TCP port, na kter√©m proxy naslouch√°."
                       required>
                <div class="invalid-feedback">Port mus√≠ b√Ωt 1‚Äì65535.</div>
              </div>

              <div class="col-sm-8">
                <label class="form-label">PROXY_TARGET_IP</label>
                <input type="text"
                       class="form-control"
                       name="PROXY_TARGET_IP"
                       value="{{ values.PROXY_TARGET_IP }}"
                       pattern="^((25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(25[0-5]|2[0-4]\d|1?\d?\d)$"
                       data-bs-toggle="tooltip"
                       title="IP c√≠lov√©ho za≈ô√≠zen√≠ (invertor/bridge) v c√≠lov√© s√≠ti."
                       required>
                <div class="invalid-feedback">Zadej platnou IPv4 adresu c√≠le.</div>
              </div>
              <div class="col-sm-4">
                <label class="form-label">PROXY_TARGET_PORT</label>
                <input type="number"
                       class="form-control"
                       name="PROXY_TARGET_PORT"
                       value="{{ values.PROXY_TARGET_PORT }}"
                       min="1" max="65535"
                       data-bs-toggle="tooltip"
                       title="TCP port c√≠lov√©ho za≈ô√≠zen√≠ (typicky 502 pro Modbus/TCP)."
                       required>
                <div class="invalid-feedback">Port mus√≠ b√Ωt 1‚Äì65535.</div>
              </div>

              <div class="col-sm-6">
                <label class="form-label">BUFFER_SIZE</label>
                <input type="number"
                       class="form-control"
                       name="BUFFER_SIZE"
                       value="{{ values.BUFFER_SIZE }}"
                       min="128" max="65536" step="1"
                       data-bs-toggle="tooltip"
                       title="Velikost ƒçtec√≠ho bufferu (B) pro proxy. 1024‚Äì4096 je obvykle dostaƒçuj√≠c√≠."
                       required>
                <div class="invalid-feedback">Zadej ƒç√≠slo 128‚Äì65536.</div>
              </div>

              <div class="col-sm-6">
                <label class="form-label">SOCK_TIMEOUT_S</label>
                <input type="number"
                       class="form-control"
                       name="SOCK_TIMEOUT_S"
                       value="{{ values.SOCK_TIMEOUT_S }}"
                       min="1" max="120" step="1"
                       data-bs-toggle="tooltip"
                       title="ƒåasov√Ω limit pro sockety (sekundy)."
                       required>
                <div class="invalid-feedback">Zadej ƒç√≠slo 1‚Äì120.</div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- Modbus / Kompatibilita -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-warning d-flex justify-content-between align-items-center">
            <strong>Modbus / kompatibilita</strong>
            <i class="bi bi-question-circle-fill"
               data-bs-toggle="tooltip"
               title="Volby pro pr√°ci s problematick√Ωmi TID/UID odpovƒõƒèmi za≈ô√≠zen√≠. TID_REWRITE p≈ôemapuje TID odpovƒõd√≠ na oƒçek√°van√© ID, TID_STRICT vynucuje po≈ôad√≠ po≈æadavek‚Üíodpovƒõƒè, STRICT_UID vynucuje shodu UnitID."></i>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <!-- TID_REWRITE -->
              <div class="col-md-4">
                <label class="form-label">TID_REWRITE</label>
                <select class="form-select" name="TID_REWRITE"
                        data-bs-toggle="tooltip"
                        title="1 = proxy oprav√≠ TID u p≈ôich√°zej√≠c√≠ch odpovƒõd√≠ podle fronty po≈æadavk≈Ø.">
                  <option value="0" {% if values.TID_REWRITE in ['0', ''] %}selected{% endif %}>0 (vypnuto)</option>
                  <option value="1" {% if values.TID_REWRITE == '1' %}selected{% endif %}>1 (zapnuto)</option>
                </select>
                <div class="form-text">Doporuƒçeno zapnout, pokud vid√≠≈° ƒçetn√© <code>stray_response</code> / <code>out_of_order</code>.</div>
              </div>
              <!-- TID_STRICT -->
              <div class="col-md-4">
                <label class="form-label">TID_STRICT</label>
                <select class="form-select" name="TID_STRICT"
                        data-bs-toggle="tooltip"
                        title="1 = striktnƒõ odm√≠tnout odpovƒõƒè s neoƒçek√°van√Ωm TID (nepokus√≠ se o korekci).">
                  <option value="0" {% if values.TID_STRICT in ['0', ''] %}selected{% endif %}>0 (benevolentn√≠)</option>
                  <option value="1" {% if values.TID_STRICT == '1' %}selected{% endif %}>1 (striktn√≠)</option>
                </select>
                <div class="form-text">Zapni jen pro striktn√≠ klienty / diagnostiku.</div>
              </div>
              <!-- STRICT_UID -->
              <div class="col-md-4">
                <label class="form-label">STRICT_UID</label>
                <select class="form-select" name="STRICT_UID"
                        data-bs-toggle="tooltip"
                        title="1 = vynutit shodu UnitID mezi po≈æadavkem a odpovƒõd√≠ (mimo TID kontrolu).">
                  <option value="0" {% if values.STRICT_UID in ['0', ''] %}selected{% endif %}>0 (vypnuto)</option>
                  <option value="1" {% if values.STRICT_UID == '1' %}selected{% endif %}>1 (zapnuto)</option>
                </select>
                <div class="form-text">Zapni, pokud za≈ô√≠zen√≠ pos√≠l√° odpovƒõdi s ‚Äûdivn√Ωm‚Äú UID.</div>
              </div>
              <!-- PASS_STRAY -->
              <div class="col-md-6">
                <label class="form-label">PASS_STRAY</label>
                <select class="form-select" name="PASS_STRAY"
                        data-bs-toggle="tooltip"
                        title="1 = proxy v≈ædy po≈°le i stray_response klientovi, 0 = m≈Ø≈æe zahodit.">
                  <option value="0" {% if values.PASS_STRAY in ['0', ''] %}selected{% endif %}>0 (nepos√≠lat)</option>
                  <option value="1" {% if values.PASS_STRAY == '1' %}selected{% endif %}>1 (pos√≠lat)</option>
                </select>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- Logging -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <strong>Logov√°n√≠</strong>
            <i class="bi bi-question-circle-fill"
               data-bs-toggle="tooltip"
               title="Rotuj√≠c√≠ logy s mo≈ænost√≠ hex dumpu r√°mc≈Ø a ≈ô√≠zenou frekvenc√≠ uk√°zek."></i>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">LOG_FILE</label>
                <input type="text"
                       class="form-control"
                       name="LOG_FILE"
                       value="{{ values.LOG_FILE }}"
                       data-bs-toggle="tooltip"
                       title="Cesta k log souboru. Ujisti se, ≈æe slu≈æba m√° pr√°va z√°pisu.">
                <div class="form-text">Nap≈ô. <code>/var/log/modbus_proxy.log</code></div>
              </div>

              <div class="col-sm-6">
                <label class="form-label">LOG_LEVEL</label>
                <select class="form-select" name="LOG_LEVEL"
                        data-bs-toggle="tooltip"
                        title="√örove≈à logov√°n√≠. DEBUG je nejpodrobnƒõj≈°√≠.">
                  {% set levels = ['DEBUG','INFO','WARNING','ERROR'] %}
                  {% for lvl in levels %}
                    <option value="{{ lvl }}" {% if values.LOG_LEVEL == lvl %}selected{% endif %}>{{ lvl }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-sm-6">
                <label class="form-label">LOG_HEXDUMP</label>
                <select class="form-select" name="LOG_HEXDUMP"
                        data-bs-toggle="tooltip"
                        title="Zapnout/vypnout hexdump (uk√°zky r√°mc≈Ø v logu).">
                  <option value="0" {% if values.LOG_HEXDUMP in ['0','false','False',''] %}selected{% endif %}>0 / false</option>
                  <option value="1" {% if values.LOG_HEXDUMP in ['1','true','True'] %}selected{% endif %}>1 / true</option>
                </select>
              </div>

              <div class="col-sm-6">
                <label class="form-label">LOG_SAMPLE_BYTES</label>
                <input type="number"
                       class="form-control"
                       name="LOG_SAMPLE_BYTES"
                       value="{{ values.LOG_SAMPLE_BYTES }}"
                       min="0" max="2048"
                       data-bs-toggle="tooltip"
                       title="Kolik bajt≈Ø payloadu se m√° ukazovat v hexdumpu. 0 = bez uk√°zky.">
              </div>

              <div class="col-sm-6">
                <label class="form-label">LOG_STATS_INTERVAL</label>
                <input type="number"
                       class="form-control"
                       name="LOG_STATS_INTERVAL"
                       value="{{ values.LOG_STATS_INTERVAL }}"
                       min="1" max="3600"
                       data-bs-toggle="tooltip"
                       title="Interval (s) pro souhrnn√© statistiky v logu.">
              </div>

              <div class="col-sm-6">
                <label class="form-label">LOG_MAX_BYTES</label>
                <input type="number"
                       class="form-control"
                       name="LOG_MAX_BYTES"
                       value="{{ values.LOG_MAX_BYTES }}"
                       min="10240" step="10240"
                       data-bs-toggle="tooltip"
                       title="Max. velikost souboru p≈ôed rotac√≠ (B).">
              </div>

              <div class="col-sm-6">
                <label class="form-label">LOG_BACKUP_COUNT</label>
                <input type="number"
                       class="form-control"
                       name="LOG_BACKUP_COUNT"
                       value="{{ values.LOG_BACKUP_COUNT }}"
                       min="0" max="50"
                       data-bs-toggle="tooltip"
                       title="Poƒçet uchov√°van√Ωch rotovan√Ωch soubor≈Ø.">
              </div>
              <!-- DROP_STRAY_SILENT -->
              <div class="col-sm-6">
                <label class="form-label">DROP_STRAY_SILENT</label>
                <select class="form-select" name="DROP_STRAY_SILENT"
                        data-bs-toggle="tooltip"
                        title="1 = tich√© ignorov√°n√≠ stray odpovƒõd√≠ bez varov√°n√≠ v logu.">
                  <option value="0" {% if values.DROP_STRAY_SILENT in ['0',''] %}selected{% endif %}>0 (logovat)</option>
                  <option value="1" {% if values.DROP_STRAY_SILENT == '1' %}selected{% endif %}>1 (ignorovat potichu)</option>
                </select>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- MQTT -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <strong>MQTT</strong>
            <i class="bi bi-question-circle-fill"
               data-bs-toggle="tooltip"
               title="Voliteln√© metriky proxy p≈ôes MQTT ‚Äì pr≈Øbƒõ≈æn√© reporty stavu."></i>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-sm-4">
                <label class="form-label">MQTT_ENABLED</label>
                <select class="form-select" name="MQTT_ENABLED"
                        data-bs-toggle="tooltip"
                        title="Zapnout/vypnout MQTT reporting.">
                  <option value="0" {% if values.MQTT_ENABLED == '0' %}selected{% endif %}>0 (vypnuto)</option>
                  <option value="1" {% if values.MQTT_ENABLED == '1' %}selected{% endif %}>1 (zapnuto)</option>
                </select>
              </div>
              <div class="col-sm-8">
                <label class="form-label">MQTT_HOST</label>
                <input type="text" class="form-control" name="MQTT_HOST" value="{{ values.MQTT_HOST }}"
                       data-bs-toggle="tooltip" title="Adresa MQTT brokeru (hostname/IP).">
              </div>
              <div class="col-sm-4">
                <label class="form-label">MQTT_PORT</label>
                <input type="number" class="form-control" name="MQTT_PORT" value="{{ values.MQTT_PORT }}"
                       min="1" max="65535"
                       data-bs-toggle="tooltip" title="Port brokeru (obvykle 1883).">
                <div class="invalid-feedback">Port mus√≠ b√Ωt 1‚Äì65535.</div>
              </div>
              <div class="col-sm-8">
                <label class="form-label">MQTT_TOPIC_PREFIX</label>
                <input type="text" class="form-control" name="MQTT_TOPIC_PREFIX" value="{{ values.MQTT_TOPIC_PREFIX }}"
                       data-bs-toggle="tooltip" title="Prefix t√©mat (nap≈ô. rpi/proxy).">
              </div>
              <div class="col-sm-6">
                <label class="form-label">MQTT_REPORT_INTERVAL</label>
                <input type="number" class="form-control" name="MQTT_REPORT_INTERVAL" value="{{ values.MQTT_REPORT_INTERVAL }}"
                       min="5" max="3600"
                       data-bs-toggle="tooltip" title="Interval (s) pro odes√≠l√°n√≠ metrik.">
                <div class="invalid-feedback">Zadej 5‚Äì3600 s.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- UI -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <strong>UI p≈ô√≠stup</strong>
            <i class="bi bi-question-circle-fill"
               data-bs-toggle="tooltip"
               title="Heslo se ulo≈æ√≠ v .env v prost√©m textu ‚Äì pou≈æ√≠vej d≈Øvƒõryhodnou s√≠≈•."></i>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">UI_USER</label>
                <input type="text" class="form-control" name="UI_USER" value="{{ values.UI_USER }}"
                       required data-bs-toggle="tooltip" title="U≈æivatelsk√© jm√©no pro p≈ôihl√°≈°en√≠.">
                <div class="invalid-feedback">Vypl≈à u≈æivatelsk√© jm√©no.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">UI_PASS</label>
                <input type="password" class="form-control" name="UI_PASS" value="{{ values.UI_PASS }}"
                       required data-bs-toggle="tooltip" title="Heslo pro p≈ôihl√°≈°en√≠.">
                <div class="invalid-feedback">Vypl≈à heslo.</div>
              </div>
              <div class="col-md-8">
                <label class="form-label">UI_SECRET (Flask session)</label>
                <input type="text" class="form-control" name="UI_SECRET" value="{{ values.UI_SECRET }}"
                       minlength="16" required
                       data-bs-toggle="tooltip" title="Tajn√Ω kl√≠ƒç pro sessions (min. 16 znak≈Ø).">
                <div class="invalid-feedback">Zadej alespo≈à 16 znak≈Ø.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">PORT (web rozhran√≠)</label>
                <input type="number" class="form-control" name="PORT" value="{{ values.PORT }}"
                       min="1" max="65535" required
                       data-bs-toggle="tooltip" title="Port, na kter√©m bƒõ≈æ√≠ UI.">
                <div class="invalid-feedback">Port mus√≠ b√Ωt 1‚Äì65535.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="d-flex justify-content-end mt-4">
      <button type="submit" class="btn btn-primary btn-lg">
        üíæ Ulo≈æit zmƒõny
      </button>
    </div>
  </form>
</div>

<!-- Inicializace tooltip≈Ø + klientsk√° validace -->
<script>
  // Bootstrap tooltippy
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
    new bootstrap.Tooltip(el);
  });

  // Jednoduch√© klientsk√© ovƒõ≈ôen√≠ formul√°≈ôe
  (function () {
    const form = document.getElementById('envForm');
    form.addEventListener('submit', function (event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  })();
</script>
{% endblock %}
